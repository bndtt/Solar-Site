const CONFIG={USE_API_ROUTE:true,OPENROUTER_MODEL:'anthropic/claude-3.5-sonnet',COST_PER_WATT:2.50,FEDERAL_TAX_CREDIT:0.30,AVG_SUN_HOURS:4.5,PANEL_WATTAGE:400,ELECTRICITY_RATE:0.15,ANNUAL_RATE_INCREASE:0.03,SYSTEM_DEGRADATION:0.005};
let currentStep=1,formData={},quoteData={};
document.addEventListener('DOMContentLoaded',()=>{initForm();initFAQ()});
function initForm(){const form=document.getElementById('quoteForm');document.querySelectorAll('.next-step').forEach(btn=>{btn.addEventListener('click',()=>{if(validateStep(currentStep)){saveStepData(currentStep);goToStep(currentStep+1)}})});document.querySelectorAll('.prev-step').forEach(btn=>{btn.addEventListener('click',()=>{goToStep(currentStep-1)})});form.addEventListener('submit',async e=>{e.preventDefault();if(validateStep(currentStep)){saveStepData(currentStep);await generateQuote()}})}
function validateStep(step){const stepEl=document.querySelector(`[data-step="${step}"]`);const inputs=stepEl.querySelectorAll('input[required]');let valid=true;inputs.forEach(input=>{if(!input.value.trim()){input.style.borderColor='#ef4444';valid=false}else{input.style.borderColor=''}});return valid}
function saveStepData(step){const stepEl=document.querySelector(`[data-step="${step}"]`);const inputs=stepEl.querySelectorAll('input');inputs.forEach(input=>{if(input.type==='radio'){if(input.checked)formData[input.name]=input.value}else{formData[input.name]=input.value}})}
function goToStep(step){if(step<1||step>4)return;document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');document.querySelector(`[data-step="${step}"]`).classList.add('active');const progress=(step/4)*100;document.querySelector('.progress').style.width=`${progress}%`;document.querySelectorAll('.indicator').forEach((ind,i)=>{ind.classList.toggle('active',i<step)});currentStep=step}
async function generateQuote(){const submitBtn=document.querySelector('[type="submit"]');const originalText=submitBtn.textContent;submitBtn.textContent='Calculating...';submitBtn.disabled=true;try{quoteData=calculateSolarSystem(formData);const overlay=document.createElement('div');overlay.className='loading-overlay';overlay.innerHTML='<img src="https://cdn.dribbble.com/userupload/22201854/file/original-0dfd8c40513007146df644e34920e3b3.gif" alt="Loading" style="width:150px;height:150px"><div class="loading-text">Analyzing your home...</div><div class="loading-subtext">Calculating solar potential, savings, and system requirements</div><div class="loading-progress"><div class="loading-progress-bar"></div></div>';document.body.appendChild(overlay);await new Promise(r=>setTimeout(r,10000));overlay.remove();displayResults(quoteData);await generateAIAnalysis(formData,quoteData);document.getElementById('quote').style.display='none';document.getElementById('results').style.display='block';document.getElementById('results').scrollIntoView({behavior:'smooth'})}catch(error){console.error('Error:',error);alert('Error generating quote. Please try again.')}finally{submitBtn.textContent=originalText;submitBtn.disabled=false}}
function calculateSolarSystem(data){const monthlyBill=parseFloat(data.bill)||150;const wantsBattery=data.battery==='yes';const hasEV=data.ev==='yes'||data.ev==='planning';const monthlyKWh=monthlyBill/CONFIG.ELECTRICITY_RATE;const evBuffer=hasEV?300:0;const totalMonthlyKWh=monthlyKWh+evBuffer;const systemEfficiency=0.85;const requiredKW=totalMonthlyKWh/(CONFIG.AVG_SUN_HOURS*30*systemEfficiency);const systemSizeKW=Math.ceil(requiredKW*10)/10;const panelCount=Math.ceil((systemSizeKW*1000)/CONFIG.PANEL_WATTAGE);const systemCost=systemSizeKW*1000*CONFIG.COST_PER_WATT;const batteryCost=wantsBattery?12000:0;const totalCost=systemCost+batteryCost;const afterTaxCredit=totalCost*(1-CONFIG.FEDERAL_TAX_CREDIT);const monthlySavings=monthlyBill*0.9;let totalSavings=0;let currentAnnualSavings=monthlySavings*12;for(let year=0;year<25;year++){const degradedOutput=1-(CONFIG.SYSTEM_DEGRADATION*year);const increasedRate=Math.pow(1+CONFIG.ANNUAL_RATE_INCREASE,year);totalSavings+=currentAnnualSavings*degradedOutput*increasedRate}const netSavings=totalSavings-afterTaxCredit;const annualSavings=monthlySavings*12;const paybackYears=afterTaxCredit/annualSavings;return{systemSizeKW,panelCount,totalCost:Math.round(totalCost),afterTaxCredit:Math.round(afterTaxCredit),monthlySavings:Math.round(monthlySavings),totalSavings:Math.round(netSavings),paybackYears:Math.round(paybackYears*10)/10,wantsBattery,hasEV,monthlyBill}}
function displayResults(quote){document.getElementById('systemSize').textContent=`${quote.systemSizeKW} kW`;document.getElementById('panelCount').textContent=`${quote.panelCount} panels`;document.getElementById('totalCost').textContent=formatCurrency(quote.totalCost);document.getElementById('afterCredit').textContent=formatCurrency(quote.afterTaxCredit);document.getElementById('monthlySavings').textContent=formatCurrency(quote.monthlySavings);document.getElementById('totalSavings').textContent=formatCurrency(quote.totalSavings);const paybackPercent=(quote.paybackYears/25)*100;document.getElementById('paybackProgress').style.width=`${paybackPercent}%`;document.getElementById('paybackMarker').style.left=`${paybackPercent}%`;document.getElementById('paybackMarker').textContent=`${quote.paybackYears} years`}
function formatCurrency(amount){return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(amount)}
async function generateAIAnalysis(formData,quoteData){const summaryEl=document.getElementById('aiSummary');if(!CONFIG.USE_API_ROUTE){summaryEl.innerHTML=`<h3>ðŸ’¡ AI Analysis</h3><p>Based on your ${formatCurrency(quoteData.monthlyBill)} monthly bill, a ${quoteData.systemSizeKW}kW system with ${quoteData.panelCount} panels would cover approximately 90% of your electricity needs. With the 30% federal tax credit, your net cost would be ${formatCurrency(quoteData.afterTaxCredit)}, and you'd break even in about ${quoteData.paybackYears} years. After that, it's pure savings â€” we estimate ${formatCurrency(quoteData.totalSavings)} over 25 years.</p>${quoteData.wantsBattery?'<p>Since you\'re interested in battery backup, we\'ve included a battery system that can power essential loads during outages.</p>':''}${quoteData.hasEV?'<p>We\'ve sized your system to accommodate EV charging, adding approximately 300 kWh/month to your production capacity.</p>':''}<p><em>Add your OpenRouter API key in app.js to enable personalized AI analysis.</em></p>`;return}summaryEl.innerHTML=`<h3>ðŸ’¡ AI Analysis</h3><p><span class="typing-indicator"><span></span><span></span><span></span></span> Analyzing...</p>`;const prompt=`You are a solar consultant. Based on this info, provide a brief personalized analysis (2-3 paragraphs).\n\nCustomer: ${formData.name}, Location: ${formData.address}, Bill: $${formData.bill}/mo, Battery: ${formData.battery}, EV: ${formData.ev}\nSystem: ${quoteData.systemSizeKW}kW, ${quoteData.panelCount} panels, Cost after credit: ${formatCurrency(quoteData.afterTaxCredit)}, Monthly savings: ${formatCurrency(quoteData.monthlySavings)}, Payback: ${quoteData.paybackYears} years, 25yr savings: ${formatCurrency(quoteData.totalSavings)}\n\nAddress them by first name. Be warm and helpful.`;try{const response=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:CONFIG.OPENROUTER_MODEL,messages:[{role:'user',content:prompt}],max_tokens:500,temperature:0.7})});if(!response.ok)throw new Error('API failed');const data=await response.json();summaryEl.innerHTML=`<h3>ðŸ’¡ AI Analysis</h3><p>${data.choices[0].message.content.replace(/\n\n/g,'</p><p>')}</p>`}catch(error){summaryEl.innerHTML=`<h3>ðŸ’¡ Quick Summary</h3><p>Based on your ${formatCurrency(quoteData.monthlyBill)} monthly bill, a ${quoteData.systemSizeKW}kW system would be ideal. You'll save ~${formatCurrency(quoteData.monthlySavings)}/month and break even in about ${quoteData.paybackYears} years.</p>`}}
let chatHistory=[];
function toggleChat(){const chatWindow=document.getElementById('chatWindow');chatWindow.classList.toggle('open');if(chatWindow.classList.contains('open'))document.getElementById('chatInput').focus()}
function openChat(){const chatWindow=document.getElementById('chatWindow');if(!chatWindow.classList.contains('open'))chatWindow.classList.add('open');document.getElementById('chatInput').focus()}
function handleChatKeypress(event){if(event.key==='Enter')sendMessage()}
async function sendMessage(){const input=document.getElementById('chatInput');const message=input.value.trim();if(!message)return;addChatMessage(message,'user');input.value='';chatHistory.push({role:'user',content:message});const typingEl=addChatMessage('','bot',true);try{const response=await getChatResponse(message);typingEl.remove();addChatMessage(response,'bot');chatHistory.push({role:'assistant',content:response})}catch(error){typingEl.remove();addChatMessage('Sorry, I had trouble connecting. Please try again.','bot')}}
function addChatMessage(text,sender,isTyping=false){const messagesEl=document.getElementById('chatMessages');const messageEl=document.createElement('div');messageEl.className=`message ${sender}${isTyping?' typing':''}`;if(isTyping){messageEl.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>'}else{messageEl.innerHTML=`<p>${text}</p>`}messagesEl.appendChild(messageEl);messagesEl.scrollTop=messagesEl.scrollHeight;return messageEl}
async function getChatResponse(userMessage){if(!CONFIG.USE_API_ROUTE)return getFallbackResponse(userMessage);const systemPrompt=`You are a friendly solar assistant. Help with solar panels, savings, installation, financing. Keep responses concise (2-3 sentences).${Object.keys(quoteData).length>0?` User's quote: ${quoteData.systemSizeKW}kW system, ${formatCurrency(quoteData.afterTaxCredit)} after credit, ${formatCurrency(quoteData.monthlySavings)}/mo savings, ${quoteData.paybackYears}yr payback.`:''}`;const messages=[{role:'system',content:systemPrompt},...chatHistory.slice(-10),{role:'user',content:userMessage}];const response=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${CONFIG.OPENROUTER_API_KEY}`,'HTTP-Referer':window.location.origin},body:JSON.stringify({model:CONFIG.OPENROUTER_MODEL,messages:messages,max_tokens:300,temperature:0.7})});if(!response.ok)throw new Error('Chat failed');const data=await response.json();return data.choices[0].message.content}
function getFallbackResponse(message){const m=message.toLowerCase();if(m.includes('tax credit')||m.includes('incentive'))return'The federal solar tax credit lets you deduct 30% of installation costs from your taxes. For a $20,000 system, that\'s $6,000 back! Available through 2032.';if(m.includes('how long')||m.includes('install'))return'Installation takes 1-3 days. The full process from signing to power-on is typically 2-3 months due to permits and utility approval.';if(m.includes('battery')||m.includes('backup'))return'A battery backup stores excess solar energy for nighttime or outages. They cost $10-15k and can power essential loads for 8-12 hours.';if(m.includes('roof'))return'Modern solar installations are very safe for roofs. Installers use specialized mounting, and most warranties cover any roof issues from installation.';if(m.includes('save')||m.includes('saving'))return'Most homeowners save 70-90% on electricity bills. Over 25 years, that typically adds up to $20,000-$50,000+ depending on usage and rates.';if(m.includes('worth'))return'Solar is usually worth it if you own your home, have decent sun, and plan to stay 5+ years. Most systems pay for themselves in 6-10 years.';return'Great question! Get a personalized quote using our form above â€” it only takes 60 seconds and gives you specific numbers for your situation.'}
function initFAQ(){document.querySelectorAll('.faq-question').forEach(button=>{button.addEventListener('click',()=>{const item=button.parentElement;const isOpen=item.classList.contains('open');document.querySelectorAll('.faq-item').forEach(i=>i.classList.remove('open'));if(!isOpen)item.classList.add('open')})})}
document.querySelectorAll('a[href^="#"]').forEach(anchor=>{anchor.addEventListener('click',function(e){e.preventDefault();const target=document.querySelector(this.getAttribute('href'));if(target)target.scrollIntoView({behavior:'smooth'})})});
